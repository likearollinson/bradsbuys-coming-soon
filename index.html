<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NicoTEEN Dreams</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto:wght@400;700&display=swap');
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        #intro-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
            color: white;
            transition: opacity 1s ease-out;
        }
        #intro-screen h1 {
            font-family: 'Playfair Display', serif;
            font-size: 5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
        #intro-screen h2 {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 3rem;
            margin-top: 0;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
        #intro-screen p {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
        }
        .action-button {
            padding: 1rem 2rem;
            margin: 0.5rem;
            font-size: 1.5rem;
            color: #000;
            background-color: #fff;
            border: 2px solid #000;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .action-button:hover {
            background-color: #000;
            color: #fff;
            border-color: #fff;
        }
        #game-canvas {
            display: block;
        }
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px #000000;
            z-index: 10;
        }
        #message-box {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        /* How to Play Modal */
        #how-to-play-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        #how-to-play-content {
            background-color: #1a1a1a;
            color: #fff;
            padding: 40px;
            border-radius: 10px;
            max-width: 500px;
            text-align: left;
            border: 1px solid #444;
        }
        #how-to-play-content h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        #how-to-play-content p, #how-to-play-content ul {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        #how-to-play-content ul {
            list-style-position: inside;
        }
        #how-to-play-content strong {
            color: #ffff00;
        }

        /* Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            pointer-events: none; /* Allows clicks to go through the container */
        }
        .mobile-btn {
            background-color: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            color: white;
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            pointer-events: all; /* Buttons are clickable */
        }
        .mobile-btn:active {
             background-color: rgba(255, 255, 255, 0.6);
        }
        #d-pad {
            position: relative;
            width: 180px;
            height: 180px;
        }
        #move-forward { position: absolute; top: 0; left: 55px; }
        #move-backward { position: absolute; bottom: 0; left: 55px; }
        #move-left { position: absolute; top: 55px; left: 0; }
        #move-right { position: absolute; top: 55px; right: 0; }
        #jump-button-container {
            display: flex;
            align-items: flex-end;
        }
        /* Hide mobile controls on desktop */
        @media (min-width: 769px) {
            #mobile-controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="intro-screen" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://storage.googleapis.com/gemini-prod-us-west1-assets/e69c3a3344692e85_4F01559D-4F72-48DD-B7BD-CD982912C63A.jpeg');">
        <h1>NicoTEEN dreams</h1>
        <h2>ConYe</h2>
        <p>by Brad</p>
        <div>
            <button id="start-button" class="action-button">Start Game</button>
            <button id="how-to-play-button" class="action-button">How to Play</button>
        </div>
    </div>

    <div id="how-to-play-modal">
        <div id="how-to-play-content">
            <h3>How to Play</h3>
            <p><strong>Objective:</strong> Race against the clock to find and collect the glowing <strong>yellow cylinders</strong>. Each one you collect adds <strong>100 points</strong> to your score and gives you <strong>15 extra seconds</strong>.</p>
            <h4>Controls (Desktop)</h4>
            <ul>
                <li><strong>Move:</strong> W, A, S, D or Arrow Keys</li>
                <li><strong>Jump (Ollie):</strong> Space Bar</li>
            </ul>
             <h4>Controls (Mobile)</h4>
            <ul>
                <li><strong>Move:</strong> Use the directional-pad in the bottom-left corner.</li>
                <li><strong>Jump (Ollie):</strong> Use the 'JUMP' button in the bottom-right corner.</li>
            </ul>
            <button id="close-modal-button" class="action-button" style="display: block; margin: 20px auto 0;">Got it!</button>
        </div>
    </div>


    <div id="hud">
        <div id="score">Score: 0</div>
        <div id="time">Time: 120</div>
    </div>

    <div id="message-box">New Objective!</div>

    <div id="mobile-controls">
        <div id="d-pad">
            <button id="move-forward" class="mobile-btn">&#8593;</button>
            <button id="move-backward" class="mobile-btn">&#8595;</button>
            <button id="move-left" class="mobile-btn">&#8592;</button>
            <button id="move-right" class="mobile-btn">&#8594;</button>
        </div>
        <div id="jump-button-container">
            <button id="jump-button" class="mobile-btn">JUMP</button>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <audio id="soundtrack" loop>
        <source src="https://storage.googleapis.com/gemini-prod-us-west1-assets/e69c3a3344692e85_Triangle_Springs_3.mp4" type="audio/mp4">
        Your browser does not support the audio element.
    </audio>

    <script type="module">
        // --- Game Setup ---
        const introScreen = document.getElementById('intro-screen');
        const startButton = document.getElementById('start-button');
        const soundtrack = document.getElementById('soundtrack');
        const scoreEl = document.getElementById('score');
        const timeEl = document.getElementById('time');
        const messageBox = document.getElementById('message-box');

        // How to Play elements
        const howToPlayButton = document.getElementById('how-to-play-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const howToPlayModal = document.getElementById('how-to-play-modal');

        let scene, camera, renderer, world;
        let player = {
            mesh: null,
            body: null,
            direction: new THREE.Vector3(),
            speed: 25,
            isGrounded: false
        };
        const keys = {};
        const gameObjects = []; // To hold meshes and bodies for cleanup
        let score = 0;
        let time = 120;
        let timerInterval;
        let gameStarted = false;

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            introScreen.style.opacity = '0';
            setTimeout(() => {
                introScreen.style.display = 'none';
                init();
            }, 1000);
            soundtrack.play().catch(error => console.error("Audio playback failed:", error));
        });

        howToPlayButton.addEventListener('click', () => {
            howToPlayModal.style.display = 'flex';
        });

        closeModalButton.addEventListener('click', () => {
            howToPlayModal.style.display = 'none';
        });

        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        // Mobile Control Listeners
        function setupMobileControls() {
            const controls = {
                'move-forward': 'KeyW',
                'move-backward': 'KeyS',
                'move-left': 'KeyA',
                'move-right': 'KeyD',
                'jump-button': 'Space'
            };

            for (const [elementId, keyCode] of Object.entries(controls)) {
                const button = document.getElementById(elementId);
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    keys[keyCode] = true;
                }, { passive: false });
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    keys[keyCode] = false;
                }, { passive: false });
            }
        }
        setupMobileControls();


        // --- Initialization ---
        function init() {
            gameStarted = true;
            // Physics World
            world = new CANNON.World();
            world.gravity.set(0, -50, 0); // Stronger gravity
            world.broadphase = new CANNON.SAPBroadphase(world);
            world.allowSleep = true;

            // Scene and Camera
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.007);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 30);
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Create the world
            createGround();
            createCity();
            createPlayer();
            spawnObjective();

            // Start timer
            timerInterval = setInterval(() => {
                time--;
                timeEl.textContent = `Time: ${time}`;
                if (time <= 0) {
                    clearInterval(timerInterval);
                    showMessage("Game Over!");
                }
            }, 1000);

            animate();
        }

        // --- World Creation ---
        function createGround() {
            const groundShape = new CANNON.Plane();
            const groundBody = new CANNON.Body({ mass: 0 });
            groundBody.addShape(groundShape);
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.addBody(groundBody);

            const groundGeometry = new THREE.PlaneGeometry(500, 500);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, side: THREE.DoubleSide });
            const groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
            groundMesh.rotation.x = -Math.PI / 2;
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);
        }

        function createCity() {
            createBox(10, 20, 30, { x: 40, y: 10, z: 0 });
            createBox(10, 10, 10, { x: -30, y: 5, z: 20 });
            createRamp(20, 10, 20, { x: 0, y: 0, z: -50 }, {y: 0});
            createRamp(20, 15, 30, { x: -80, y: 0, z: 0 }, {y: Math.PI / 2});
            createRamp(20, 15, 30, { x: 80, y: 0, z: 0 }, {y: -Math.PI / 2});
            for (let i = 0; i < 15; i++) {
                const sizeX = Math.random() * 20 + 10;
                const sizeZ = Math.random() * 20 + 10;
                const height = Math.random() * 50 + 20;
                const posX = (Math.random() - 0.5) * 400;
                const posZ = (Math.random() - 0.5) * 400;
                if (Math.abs(posX) > 50 || Math.abs(posZ) > 50) {
                    createBox(sizeX, height, sizeZ, { x: posX, y: height / 2, z: posZ });
                }
            }
        }

        // --- Player Creation ---
        function createPlayer() {
            const playerShape = new CANNON.Sphere(1.5);
            player.body = new CANNON.Body({
                mass: 70,
                position: new CANNON.Vec3(0, 10, 0),
                shape: playerShape,
                linearDamping: 0.5,
                angularDamping: 1.0 // Prevent tipping
            });
            player.body.angularFactor.set(0, 1, 0); // Only allow rotation around Y-axis
            world.addBody(player.body);

            const playerGeometry = new THREE.CapsuleGeometry(1.2, 2, 4, 8);
            const playerMaterial = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            player.mesh = new THREE.Mesh(playerGeometry, playerMaterial);
            player.mesh.castShadow = true;
            scene.add(player.mesh);
            
            player.body.addEventListener("collide", (event) => {
               const contactNormal = event.contact.ni;
               if (contactNormal.y > 0.5) {
                   player.isGrounded = true;
               }
            });
        }
        
        // --- Objective System ---
        let currentObjective = null;

        function spawnObjective() {
            if (currentObjective) {
                scene.remove(currentObjective.mesh);
                // Also dispose of geometry and material if necessary to free up memory
            }

            const posX = (Math.random() - 0.5) * 150;
            const posZ = (Math.random() - 0.5) * 150;

            const objectiveGeometry = new THREE.CylinderGeometry(5, 5, 20, 32);
            const objectiveMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true, opacity: 0.7 });
            const objectiveMesh = new THREE.Mesh(objectiveGeometry, objectiveMaterial);
            objectiveMesh.position.set(posX, 10, posZ);

            currentObjective = {
                mesh: objectiveMesh,
                position: new THREE.Vector3(posX, 10, posZ),
                radius: 6 // slightly larger radius for easier collection
            };
            scene.add(objectiveMesh);
            showMessage("New Objective!");
        }

        // --- Helper functions ---
        function createBox(width, height, depth, position, rotation = {x:0, y:0, z:0}) {
            const shape = new CANNON.Box(new CANNON.Vec3(width / 2, height / 2, depth / 2));
            const body = new CANNON.Body({ mass: 0 });
            body.addShape(shape);
            body.position.set(position.x, position.y, position.z);
            body.quaternion.setFromEuler(rotation.x, rotation.y, rotation.z);
            world.addBody(body);

            const geometry = new THREE.BoxGeometry(width, height, depth);
            const material = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.copy(body.position);
            mesh.quaternion.copy(body.quaternion);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            gameObjects.push({mesh, body});
        }
        
        function createRamp(width, height, depth, position, rotation) {
            const geometry = new THREE.BoxGeometry(width, height, depth);
            const material = new THREE.MeshStandardMaterial({ color: 0x8888ff });
            const mesh = new THREE.Mesh(geometry, material);
            
            // We create a custom shape from a box for the ramp
            const shape = new CANNON.Box(new CANNON.Vec3(width / 2, height / 2, depth / 2));
            const body = new CANNON.Body({ mass: 0 });

            mesh.position.set(position.x, position.y + height / 2, position.z);
            mesh.quaternion.setFromEuler(0, rotation.y, 0);

            const rampAngle = Math.atan2(height, depth);
            mesh.rotation.x += rampAngle; // Visual rotation

            body.position.copy(mesh.position);
            body.quaternion.copy(mesh.quaternion);
            
            // Adjust body rotation to match the visual ramp slope
            const cannonQuaternion = new CANNON.Quaternion();
            cannonQuaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), rampAngle);
            body.quaternion = body.quaternion.mult(cannonQuaternion);

            body.addShape(shape);
            world.addBody(body);
            
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            gameObjects.push({mesh, body});
        }

        // --- Game Logic and Controls ---
        function updatePlayer() {
            if (!player.body) return;
            
            // Reset grounded state at the start of each frame
            // The collision listener will set it to true if a collision occurs
            player.isGrounded = false;
            world.contacts.forEach(contact => {
                 if(contact.bi === player.body || contact.bj === player.body){
                    // Check which body is the player and get the contact normal accordingly
                    const normal = contact.bi === player.body ? contact.ni : new CANNON.Vec3(-contact.ni.x, -contact.ni.y, -contact.ni.z);
                    if (normal.y > 0.5) {
                        player.isGrounded = true;
                    }
                }
            });


            const forward = new THREE.Vector3();
            camera.getWorldDirection(forward);
            forward.y = 0;
            forward.normalize();
            
            const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();
            
            // Note: In Three.js, the positive Z-axis is coming out of the screen.
            // Right vector needs to be negated for intuitive A/D controls.
            const moveDirection = new THREE.Vector3();
            if (keys['ArrowUp'] || keys['KeyW']) {
                moveDirection.add(forward);
            }
            if (keys['ArrowDown'] || keys['KeyS']) {
                moveDirection.sub(forward);
            }
            if (keys['ArrowLeft'] || keys['KeyA']) {
                moveDirection.sub(right);
            }
            if (keys['ArrowRight'] || keys['KeyD']) {
                moveDirection.add(right);
            }
            
            moveDirection.normalize();
            const force = new CANNON.Vec3(
                moveDirection.x * player.speed, 
                0, 
                moveDirection.z * player.speed
            );
            
            if (player.isGrounded) {
                 player.body.applyForce(force, player.body.position);
            }
            
            // Ollie (Jump)
            if (keys['Space'] && player.isGrounded) {
                player.body.velocity.y = 25; // Apply an upward impulse
                player.isGrounded = false; // Prevent double-jumping in the same frame
            }
        }
        
        function checkObjectiveCollision() {
            if (!player.body || !currentObjective) return;
            const playerPos = player.body.position;
            const objectivePos = currentObjective.position;
            const distance = playerPos.distanceTo(new CANNON.Vec3(objectivePos.x, playerPos.y, objectivePos.z));

            if (distance < currentObjective.radius) {
                score += 100;
                time += 15;
                scoreEl.textContent = `Score: ${score}`;
                timeEl.textContent = `Time: ${time}`;
                spawnObjective();
            }
        }
        
        function showMessage(text) {
            messageBox.textContent = text;
            messageBox.style.opacity = '1';
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 2000);
        }

        // --- Game Loop ---
        const clock = new THREE.Clock();
        function animate() {
            if (time <= 0 && gameStarted) return;
            requestAnimationFrame(animate);
            const deltaTime = clock.getDelta();

            world.step(1/60, deltaTime, 3); // Fixed timestep

            updatePlayer();
            checkObjectiveCollision();

            if (player.mesh && player.body) {
                player.mesh.position.copy(player.body.position);
                player.mesh.position.y -= 1; // Adjust visual mesh to align with spherical physics body
            }
            
            // Update camera to follow player smoothly
            const cameraOffset = new THREE.Vector3(0, 8, 15);
            const playerPosition = new THREE.Vector3().copy(player.body.position);
            const cameraTargetPosition = playerPosition.clone().add(cameraOffset);
            camera.position.lerp(cameraTargetPosition, 0.1);
            camera.lookAt(playerPosition);
            
            if (currentObjective) {
                currentObjective.mesh.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            if (!gameStarted) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>